<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoreAdmin - Mobile App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        /* ซ่อน Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* ทำ Modal/Bottom Sheet */
        .bottom-sheet {
            transition: transform 0.3s ease-out;
            transform: translateY(100%);
        }
        .bottom-sheet.active { transform: translateY(0); }
        .overlay { opacity: 0; pointer-events: none; transition: 0.3s; }
        .overlay.active { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="text-slate-800 pb-24">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <div class="bg-orange-500 w-8 h-8 rounded-lg flex items-center justify-center shadow-lg shadow-orange-500/20">
                <i class="fa-solid fa-box-archive text-sm text-white"></i>
            </div>
            <span class="text-lg font-bold tracking-tight">Store<span class="text-orange-500">Hub</span></span>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleCategoryModal()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="fa-solid fa-tags text-sm"></i>
            </button>
            <a href="admin-orders.html" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="fa-solid fa-chart-line text-sm"></i>
            </a>
        </div>
    </header>

    <main class="p-4">
        <div class="bg-white rounded-2xl p-4 mb-6 shadow-sm border border-slate-100 flex justify-between items-center">
            <div>
                <p class="text-slate-400 text-xs uppercase font-bold tracking-wider">คลังสินค้าทั้งหมด</p>
                <h2 id="product-count" class="text-2xl font-bold text-slate-900">0 รายการ</h2>
            </div>
            <button onclick="openForm()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-orange-500/30 active:scale-95 transition-all">
                + เพิ่มสินค้า
            </button>
        </div>

        <h3 class="text-sm font-bold text-slate-500 mb-4 px-1 uppercase tracking-widest">รายการสินค้า</h3>
        
        <div id="loader" class="py-12 text-center">
            <div class="inline-block w-8 h-8 border-4 border-orange-500/20 border-t-orange-500 rounded-full animate-spin"></div>
        </div>

        <div id="product-list-container" class="space-y-3">
            </div>

        <div id="empty-state" class="hidden py-12 text-center">
            <i class="fa-solid fa-box-open text-4xl text-slate-200 mb-3"></i>
            <p class="text-slate-400 text-sm">ไม่พบสินค้าในระบบ</p>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-slate-200 px-6 py-3 z-50 flex justify-around items-center safe-area-bottom">
        <button class="flex flex-col items-center text-orange-500">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-[10px] mt-1 font-medium">คลังสินค้า</span>
        </button>
        <button onclick="openForm()" class="flex flex-col items-center text-slate-400">
            <div class="bg-slate-900 w-12 h-12 rounded-full flex items-center justify-center -mt-8 shadow-xl border-4 border-white">
                <i class="fa-solid fa-plus text-white text-xl"></i>
            </div>
            <span class="text-[10px] mt-1 font-medium">เพิ่มสินค้า</span>
        </button>
        <a href="index.html" class="flex flex-col items-center text-orange-500">
            <i class="fa-solid fa-eye text-xl"></i>
            <span class="text-[10px] mt-1 font-medium">ดูหน้าร้าน</span>
        </a>
    </div>

    <div id="cat-overlay" onclick="toggleCategoryModal()" class="overlay fixed inset-0 bg-black/40 z-[55]"></div>
    <div id="cat-sheet" class="bottom-sheet fixed bottom-0 left-0 right-0 bg-white rounded-t-[32px] z-[60] max-h-[80vh] overflow-hidden flex flex-col">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto my-4"></div>
        <div class="px-6 pb-8 overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">จัดการหมวดหมู่</h3>
            <div class="flex gap-2 mb-6">
                <input type="text" id="new-cat-name" placeholder="ชื่อหมวดหมู่ใหม่..." class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-orange-500">
                <button onclick="addCategory()" class="bg-slate-900 text-white px-4 rounded-xl font-bold text-sm">เพิ่ม</button>
            </div>
            <div id="category-tags" class="flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div id="form-modal" class="fixed inset-0 bg-white z-[70] translate-y-full transition-transform duration-300 overflow-y-auto">
        <div class="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
            <button onclick="closeForm()" class="text-slate-400 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 id="form-title" class="font-bold text-lg">เพิ่มสินค้าใหม่</h2>
            <div class="w-10"></div>
        </div>
        <form id="product-form" class="p-6 space-y-6">
            <input type="hidden" id="edit-id">
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">ชื่อสินค้า</label>
                <input type="text" id="p_name" required class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 mt-1 outline-none focus:border-orange-500">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">ราคา (฿)</label>
                    <input type="number" id="p_price" required class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">หมวดหมู่</label>
                    <select id="p_category" class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 mt-1 appearance-none"></select>
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">รายละเอียด</label>
                <textarea id="p_description" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 mt-1"></textarea>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">ลิงก์รูปภาพ (หลัก)</label>
                <input type="url" class="p-image-input w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 mt-1" placeholder="https://..." required>
            </div>
            <details class="group">
                <summary class="list-none text-orange-500 text-sm font-bold cursor-pointer flex items-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i> เพิ่มรูปภาพเพิ่มเติม (สูงสุด 5)
                </summary>
                <div class="pt-4 space-y-3">
                    <input type="url" class="p-image-input w-full bg-slate-50 border border-slate-200 rounded-2xl p-4" placeholder="URL รูปที่ 2">
                    <input type="url" class="p-image-input w-full bg-slate-50 border border-slate-200 rounded-2xl p-4" placeholder="URL รูปที่ 3">
                    <input type="url" class="p-image-input w-full bg-slate-50 border border-slate-200 rounded-2xl p-4" placeholder="URL รูปที่ 4">
                    <input type="url" class="p-image-input w-full bg-slate-50 border border-slate-200 rounded-2xl p-4" placeholder="URL รูปที่ 5">
                </div>
            </details>

            <div class="pt-6">
                <button type="submit" id="btn-save" class="w-full bg-orange-500 text-white font-bold py-4 rounded-2xl shadow-xl shadow-orange-500/20 active:scale-95 transition-all">
                    บันทึกข้อมูลสินค้า
                </button>
                <button type="button" onclick="closeForm()" class="w-full text-slate-400 font-bold py-4 mt-2">ยกเลิก</button>
            </div>
        </form>
    </div>

    <script>
        const SB_URL = 'https://eodbsetbyryimczkhoaw.supabase.co';
        const SB_KEY = 'sb_publishable_pWCFODdbMNdtx0_tytIXjw_jEry84HD'; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // UI Logic
        function openForm() { 
            document.getElementById('form-modal').style.transform = 'translateY(0)';
            document.body.style.overflow = 'hidden';
        }
        function closeForm() { 
            document.getElementById('form-modal').style.transform = 'translateY(100%)';
            document.body.style.overflow = 'auto';
            resetForm();
        }
        function toggleCategoryModal() {
            document.getElementById('cat-sheet').classList.toggle('active');
            document.getElementById('cat-overlay').classList.toggle('active');
        }

        // Functions เดิม (ปรับปรุง UI injection)
        async function fetchCategories() {
            const { data, error } = await _supabase.from('categories').select('*').order('name');
            if (error) return;
            const dropdown = document.getElementById('p_category');
            const tagContainer = document.getElementById('category-tags');
            dropdown.innerHTML = '<option value="">เลือกหมวดหมู่</option>';
            tagContainer.innerHTML = '';
            data?.forEach(cat => {
                dropdown.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                tagContainer.innerHTML += `
                    <div class="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-full text-sm font-medium">
                        <span>${cat.name}</span>
                        <button onclick="deleteCategory(${cat.id})" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
            });
        }

        async function fetchProducts() {
            const container = document.getElementById('product-list-container');
            const loader = document.getElementById('loader');
            const empty = document.getElementById('empty-state');
            
            loader.classList.remove('hidden');
            container.innerHTML = '';

            const { data: products, error } = await _supabase.from('products').select('*').order('id', { ascending: false });
            loader.classList.add('hidden');

            if (error || !products?.length) {
                empty.classList.remove('hidden');
                document.getElementById('product-count').innerText = '0 รายการ';
                return;
            }

            empty.classList.add('hidden');
            document.getElementById('product-count').innerText = `${products.length} รายการ`;
            
            products.forEach(p => {
                const mainImage = p.image_url?.split(',')[0] || 'https://via.placeholder.com/150';
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex gap-4 items-center animate-fadeIn">
                        <img src="${mainImage}" class="w-20 h-20 object-cover rounded-xl bg-slate-100">
                        <div class="flex-1 min-w-0">
                            <span class="text-[10px] font-bold text-orange-500 uppercase">${p.category || 'ทั่วไป'}</span>
                            <h4 class="font-bold text-slate-800 truncate">${p.name}</h4>
                            <p class="text-lg font-bold text-slate-900 mt-1">฿${Number(p.price).toLocaleString()}</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick='editProduct(${JSON.stringify(p)})' class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-pen-to-square text-xs"></i>
                            </button>
                            <button onclick="deleteProduct(${p.id})" class="w-10 h-10 bg-red-50 text-red-600 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-trash-can text-xs"></i>
                            </button>
                        </div>
                    </div>`;
            });
        }

        // Reuse logical functions from your original code (editProduct, deleteProduct, addCategory, etc.)
        // เพียงปรับการเรียก openForm() ใน editProduct
        function editProduct(p) {
            openForm();
            document.getElementById('form-title').innerText = 'แก้ไขสินค้า';
            document.getElementById('edit-id').value = p.id;
            document.getElementById('p_name').value = p.name;
            document.getElementById('p_price').value = p.price;
            document.getElementById('p_category').value = p.category || '';
            document.getElementById('p_description').value = p.description || '';
            const images = p.image_url?.split(',') || [];
            document.querySelectorAll('.p-image-input').forEach((el, i) => el.value = images[i] || '');
            document.getElementById('btn-save').innerText = 'อัปเดตข้อมูล';
        }

        function resetForm() {
            document.getElementById('product-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('form-title').innerText = 'เพิ่มสินค้าใหม่';
            document.getElementById('btn-save').innerText = 'บันทึกข้อมูลสินค้า';
        }

        // Submit Logic
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const editId = document.getElementById('edit-id').value;
            const imageUrls = Array.from(document.querySelectorAll('.p-image-input')).map(i => i.value.trim()).filter(u => u).join(',');

            const productData = {
                name: document.getElementById('p_name').value,
                price: Number(document.getElementById('p_price').value),
                category: document.getElementById('p_category').value,
                description: document.getElementById('p_description').value,
                image_url: imageUrls
            };

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i>';

            let result = editId ? 
                await _supabase.from('products').update(productData).eq('id', editId) : 
                await _supabase.from('products').insert([productData]);

            if (result.error) alert(result.error.message);
            else { closeForm(); fetchProducts(); }
            btn.disabled = false;
        });

        async function deleteProduct(id) {
            if (confirm('ลบสินค้านี้?')) {
                await _supabase.from('products').delete().eq('id', id);
                fetchProducts();
            }
        }

        async function addCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            if (!name) return;
            await _supabase.from('categories').insert([{ name }]);
            document.getElementById('new-cat-name').value = '';
            fetchCategories();
        }

        async function deleteCategory(id) {
            if (confirm('ลบหมวดหมู่?')) {
                await _supabase.from('categories').delete().eq('id', id);
                fetchCategories();
            }
        }

        // Init
        fetchCategories();
        fetchProducts();
    </script>
</body>
</html>
