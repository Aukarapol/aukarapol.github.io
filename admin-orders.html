<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OrderHub Mobile Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #f1f5f9;
        }
        .order-container {
            height: calc(100vh - 240px);
            overflow-y: auto;
            padding-bottom: 80px;
        }
        .status-pill {
            @apply px-3 py-1 rounded-full text-[10px] font-bold border;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        /* Modal Styles */
        #receipt-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body class="text-slate-900 overflow-hidden">

<header class="bg-white px-5 pt-6 pb-4 border-b border-slate-200 sticky top-0 z-40">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center shadow-lg shadow-orange-200">
                <i data-lucide="shield-check" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-[#002d72] leading-tight">Order<span class="text-orange-500">Hub</span></h1>
                <p class="text-[10px] text-slate-400 font-medium">ADMIN MANAGEMENT</p>
            </div>
        </div>
        <button onclick="fetchOrders()" class="p-2 bg-slate-100 rounded-full text-slate-600 active:scale-95 transition-colors hover:bg-slate-200">
            <i data-lucide="refresh-cw" id="refresh-icon" class="w-5 h-5"></i>
        </button>
    </div>

    <div class="grid grid-cols-2 gap-3">
        <div class="bg-blue-50 p-3 rounded-2xl flex items-center gap-3 border border-blue-100">
            <div class="p-2 bg-white rounded-lg text-blue-600 shadow-sm"><i data-lucide="package" class="w-4 h-4"></i></div>
            <div>
                <p class="text-[9px] font-bold text-blue-400 uppercase">Orders</p>
                <h3 id="stat-count" class="text-base font-bold text-blue-900">0</h3>
            </div>
        </div>
        <div class="bg-orange-50 p-3 rounded-2xl flex items-center gap-3 border border-orange-100">
            <div class="p-2 bg-white rounded-lg text-orange-600 shadow-sm"><i data-lucide="banknote" class="w-4 h-4"></i></div>
            <div>
                <p class="text-[9px] font-bold text-orange-400 uppercase">Revenue</p>
                <h3 id="stat-revenue" class="text-base font-bold text-orange-900">฿0</h3>
            </div>
        </div>
    </div>
</header>

<main class="order-container px-4 py-4" id="order-list">
    <div class="flex flex-col items-center justify-center h-full text-slate-400">
        <div class="animate-bounce mb-2"><i data-lucide="loader-2" class="w-10 h-10 animate-spin"></i></div>
        <p>กำลังโหลดข้อมูล...</p>
    </div>
</main>

<div id="receipt-modal" onclick="closeReceipt()">
    <div class="bg-white w-full max-w-md rounded-3xl overflow-hidden shadow-2xl animate-slide-up" onclick="event.stopPropagation()">
        <div class="p-6 overflow-y-auto max-h-[70vh]" id="modal-content">
            </div>
        <div class="p-4 bg-slate-50 border-t flex gap-3">
            <button onclick="closeReceipt()" class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">ปิด</button>
            <button id="modal-print-btn" class="flex-1 py-3 bg-orange-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 active:bg-orange-600">
                <i data-lucide="printer" class="w-4 h-4"></i> พิมพ์ใบเสร็จ
            </button>
        </div>
    </div>
</div>

<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-3 flex justify-between items-center z-50">
    <a href="#" class="flex flex-col items-center gap-1 text-orange-500">
        <i data-lucide="shopping-bag" class="w-6 h-6"></i>
        <span class="text-[10px] font-medium">ออเดอร์</span>
    </a>
    <a href="index.html" class="flex flex-col items-center gap-1 text-orange-500">
        <i data-lucide="external-link" class="w-6 h-6"></i>
        <span class="text-[10px] font-medium">ไปที่ร้าน</span>
    </a>
    <div class="flex flex-col items-center gap-1 text-orange-500 relative">
        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-7 h-7 rounded-full border border-slate-200" alt="admin">
        <span class="text-[10px] font-medium">โปรไฟล์</span>
    </div>
</nav>

<script>
    const SB_URL = 'https://eodbsetbyryimczkhoaw.supabase.co';
    const SB_KEY = 'sb_publishable_pWCFODdbMNdtx0_tytIXjw_jEry84HD';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let currentOrders = [];

    async function fetchOrders() {
        const list = document.getElementById('order-list');
        try {
            const { data, error } = await _supabase.from('orders').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            currentOrders = data;
            
            const totalRevenue = data.reduce((sum, o) => sum + (o.total_amount || 0), 0);
            document.getElementById('stat-count').innerText = data.length;
            document.getElementById('stat-revenue').innerText = `฿${totalRevenue.toLocaleString()}`;

            renderCards();
        } catch (err) {
            list.innerHTML = `<div class="p-10 text-center text-rose-500 font-bold">${err.message}</div>`;
        }
    }

    function renderCards() {
        const list = document.getElementById('order-list');
        if (currentOrders.length === 0) {
            list.innerHTML = `<div class="p-20 text-center text-slate-400">ไม่มีข้อมูลออเดอร์</div>`;
            return;
        }

        const statusStyles = {
            'รอดำเนินการ': 'bg-amber-50 text-amber-600 border-amber-100',
            'กำลังจัดส่ง': 'bg-blue-50 text-blue-600 border-blue-100',
            'ส่งแล้ว': 'bg-emerald-50 text-emerald-600 border-emerald-100',
            'ยกเลิก': 'bg-rose-50 text-rose-600 border-rose-100'
        };

        list.innerHTML = currentOrders.map((order, i) => {
            const date = new Date(order.created_at).toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
            const time = new Date(order.created_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 mb-4 animate-slide-up" style="animation-delay: ${i * 50}ms">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">#${order.id.toString().slice(-6)}</span>
                            <span class="status-pill ${statusStyles[order.status] || ''}">${order.status}</span>
                        </div>
                        <span class="text-[11px] text-slate-400 font-medium">${date} | ${time}</span>
                    </div>
                    
                    <div class="mb-3">
                        <h4 class="font-bold text-slate-800 text-sm">${order.customer_name}</h4>
                        <p class="text-xs text-slate-500 line-clamp-1"><i data-lucide="map-pin" class="inline w-3 h-3 mr-1"></i>${order.customer_address}</p>
                    </div>

                    <div class="flex items-center justify-between pt-3 border-t border-dashed border-slate-100">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold">ยอดสุทธิ</p>
                            <p class="text-lg font-bold text-orange-600">฿${(order.total_amount || 0).toLocaleString()}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openReceiptModal(${order.id})" class="p-2.5 bg-slate-50 text-slate-500 rounded-xl active:bg-blue-100 active:text-blue-600 transition-colors">
                                <i data-lucide="printer" class="w-5 h-5"></i>
                            </button>
                            <div class="relative">
                                <select onchange="updateStatus(${order.id}, this.value)" class="absolute opacity-0 w-full h-full inset-0 z-10 cursor-pointer">
                                    <option value="" disabled selected></option>
                                    <option value="รอดำเนินการ">รอดำเนินการ</option>
                                    <option value="กำลังจัดส่ง">กำลังจัดส่ง</option>
                                    <option value="ส่งแล้ว">ส่งแล้ว</option>
                                    <option value="ยกเลิก">ยกเลิก</option>
                                </select>
                                <button class="p-2.5 bg-slate-50 text-slate-500 rounded-xl">
                                    <i data-lucide="more-vertical" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <button onclick="deleteOrder(${order.id}, '${order.customer_name}')" class="p-2.5 bg-rose-50 text-rose-500 rounded-xl active:bg-rose-100">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    async function updateStatus(id, status) {
        if(!status) return;
        try {
            const { error } = await _supabase.from('orders').update({ status }).eq('id', id);
            if (error) throw error;
            fetchOrders();
        } catch (err) { alert(err.message); }
    }

    async function deleteOrder(id, name) {
        if (!confirm(`ลบออเดอร์คุณ ${name}?`)) return;
        try {
            await _supabase.from('orders').delete().eq('id', id);
            fetchOrders();
        } catch (err) { alert(err.message); }
    }

    function openReceiptModal(orderId) {
        const order = currentOrders.find(o => o.id === orderId);
        if (!order) return;

        let items = [];
        try {
            items = order.items ? (typeof order.items === 'string' ? JSON.parse(order.items) : order.items) : [];
        } catch(e) { console.error("Parse error", e); }

        const itemsHtml = items.map(item => `
            <div class="flex justify-between text-sm py-1 border-b border-slate-50">
                <span class="text-slate-600">${item.name} x ${item.quantity}</span>
                <span class="font-medium text-slate-800">฿${(item.price * item.quantity).toLocaleString()}</span>
            </div>
        `).join('');

        const modalContent = `
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="receipt" class="w-8 h-8"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">ใบเสร็จรับเงิน</h2>
                <p class="text-xs text-slate-400 font-medium uppercase tracking-widest">Order Receipt</p>
            </div>
            
            <div class="space-y-4">
                <div class="bg-slate-50 p-3 rounded-xl">
                    <div class="flex justify-between text-[11px] mb-1">
                        <span class="text-slate-400">Order ID:</span>
                        <span class="font-bold text-slate-700">#${order.id}</span>
                    </div>
                    <div class="flex justify-between text-[11px]">
                        <span class="text-slate-400">วันที่:</span>
                        <span class="font-bold text-slate-700">${new Date(order.created_at).toLocaleString('th-TH')}</span>
                    </div>
                </div>

                <div>
                    <h5 class="text-[10px] font-bold text-slate-400 uppercase mb-2">ลูกค้า</h5>
                    <p class="text-sm font-bold text-slate-800">${order.customer_name}</p>
                    <p class="text-xs text-slate-500">${order.customer_address}</p>
                </div>

                <div>
                    <h5 class="text-[10px] font-bold text-slate-400 uppercase mb-2">รายการสินค้า</h5>
                    ${itemsHtml || '<p class="text-xs text-slate-400 italic">ไม่มีรายการ</p>'}
                </div>

                <div class="pt-4 mt-4 border-t-2 border-dashed border-slate-200">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-800">ยอดรวมทั้งสิ้น</span>
                        <span class="text-2xl font-bold text-orange-600">฿${(order.total_amount || 0).toLocaleString()}</span>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modal-content').innerHTML = modalContent;
        document.getElementById('receipt-modal').style.display = 'flex';
        document.getElementById('modal-print-btn').onclick = () => printReceipt(orderId);
        
        lucide.createIcons();
    }

    function closeReceipt() {
        document.getElementById('receipt-modal').style.display = 'none';
    }

    function printReceipt(orderId) {
        const order = currentOrders.find(o => o.id === orderId);
        if (!order) return;

        const printWindow = window.open('', '_blank', 'width=600,height=800');
        if (!printWindow) {
            alert('กรุณาอนุญาตให้เปิด Pop-up เพื่อพิมพ์ใบเสร็จ');
            return;
        }

        let items = [];
        try {
            items = order.items ? (typeof order.items === 'string' ? JSON.parse(order.items) : order.items) : [];
        } catch(e) { items = []; }

        const itemsHtml = items.map(item => `
            <tr>
                <td style="padding: 5px 0;">${item.name} x ${item.quantity}</td>
                <td style="text-align: right;">฿${(item.price * item.quantity).toLocaleString()}</td>
            </tr>
        `).join('') || '<tr><td colspan="2">ไม่มีรายการสินค้า</td></tr>';

        printWindow.document.write(`
            <html>
                <head>
                    <title>Receipt #${order.id}</title>
                    <style>
                        body { font-family: 'Tahoma', sans-serif; padding: 20px; color: #333; line-height: 1.4; width: 300px; margin: auto; }
                        .header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
                        .info { font-size: 13px; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; }
                        .total { border-top: 2px solid #333; padding-top: 10px; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2 style="margin:0">OrderHub</h2>
                        <p style="margin:0; font-size:12px;">ขอบคุณที่ใช้บริการ</p>
                    </div>
                    <div class="info">
                        <strong>ID:</strong> #${order.id}<br>
                        <strong>วันที่:</strong> ${new Date(order.created_at).toLocaleString('th-TH')}<br>
                        <strong>ลูกค้า:</strong> ${order.customer_name}
                    </div>
                    <table>
                        <thead>
                            <tr style="border-bottom: 1px solid #eee;">
                                <th style="text-align: left;">รายการ</th>
                                <th style="text-align: right;">ราคา</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    <div class="total">
                        <span>รวมทั้งสิ้น:</span>
                        <span>฿${(order.total_amount || 0).toLocaleString()}</span>
                    </div>
                </body>
            </html>
        `);

        printWindow.document.close();
        
        // หน่วงเวลาเพื่อให้เนื้อหาโหลดสมบูรณ์ก่อนเรียกหน้าต่างพิมพ์
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 350);
    }

    // Initial Load
    fetchOrders();
    // Auto Refresh every 30s
    setInterval(fetchOrders, 30000);
</script>

</body>
</html>
