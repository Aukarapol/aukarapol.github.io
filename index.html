<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khuang Nai Tech Hub - Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Mobile Modal Style */
        .mobile-sheet {
            transition: transform 0.3s ease-out;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
        }
        .cart-sidebar { transition: transform 0.3s ease-in-out; }
        .cart-open { transform: translateY(0); }
        .cart-closed { transform: translateY(100%); }
    </style>
</head>
<body class="bg-[#F8F9FA] text-slate-900 pb-24">

<nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-gray-100 px-4 py-3">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <span class="bg-[#002D72] text-white px-2 py-0.5 rounded font-black italic text-lg">KN</span>
            <span class="font-bold text-lg text-[#002D72]">Tech<span class="text-orange-600">Hub</span></span>
        </div>
        <div id="admin-icons" class="hidden flex gap-4">
            <a href="admin-products.html" class="text-slate-600"><i class="fa-solid fa-boxes-stacked"></i></a>
            <a href="admin-orders.html" class="text-slate-600"><i class="fa-solid fa-clipboard-list"></i></a>
        </div>
    </div>
</nav>

<main class="px-4">
    <div class="mt-4 relative">
        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
        <input type="text" id="search-input" oninput="filterProducts()" 
            placeholder="ค้นหาอุปกรณ์ไอที..." 
            class="w-full pl-10 pr-4 py-3 bg-white border-none rounded-2xl shadow-sm focus:ring-2 focus:ring-[#002D72] outline-none text-sm">
    </div>

    <div class="mt-6 rounded-3xl bg-gradient-to-br from-[#002D72] to-[#004dc4] p-6 text-white relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-xl font-bold leading-tight">อัปเกรดชีวิตดิจิทัล<br>ให้โปรกว่าใคร</h2>
            <p class="text-blue-100 text-xs mt-2 opacity-80">รวมสินค้า IT ตัวท็อป ราคาโดนใจ</p>
        </div>
        <i class="fa-solid fa-microchip absolute -right-4 -bottom-4 text-6xl text-white/10 rotate-12"></i>
    </div>

    <div class="mt-8">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold">หมวดหมู่สินค้า</h3>
        </div>
        <div id="category-filters" class="flex gap-2 overflow-x-auto hide-scrollbar">
            </div>
    </div>

    <div id="sections-container" class="mt-6 space-y-8">
        </div>

    <div id="empty-state" class="hidden text-center py-12">
        <p class="text-slate-400">ไม่พบสินค้า</p>
    </div>
</main>

<div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center z-50 bottom-nav">
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="flex flex-col items-center gap-1 text-[#002D72]">
        <i class="fa-solid fa-house text-xl"></i>
        <span class="text-[10px] font-medium">หน้าแรก</span>
    </button>
    
    <button onclick="toggleCart()" class="relative flex flex-col items-center gap-1 text-[#002D72]">
        <i class="fa-solid fa-bag-shopping text-xl"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-orange-600 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center border-2 border-white">0</span>
        <span class="text-[10px] font-medium">ตะกร้า</span>
    </button>

    <div id="auth-section" class="flex flex-col items-center">
        <button id="btn-login-trigger" onclick="openLoginModal()" class="flex flex-col items-center gap-1 text-[#002D72]">
            <i class="fa-regular fa-circle-user text-xl"></i>
            <span class="text-[10px] font-medium">โปรไฟล์</span>
        </button>
        <button id="btn-logout-trigger" onclick="handleLogout()" class="hidden flex flex-col items-center gap-1 text-red-500">
            <i class="fa-solid fa-power-off text-xl"></i>
            <span class="text-[10px] font-medium">ออก</span>
        </button>
    </div>
</div>

<div id="product-modal" class="fixed inset-0 bg-black/60 z-[60] hidden">
    <div class="absolute bottom-0 left-0 right-0 bg-white mobile-sheet max-h-[90vh] overflow-y-auto custom-scrollbar">
        <div class="sticky top-0 bg-white px-4 py-3 border-b flex justify-between items-center">
            <span class="font-bold">รายละเอียดสินค้า</span>
            <button onclick="closeProductModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="p-4">
            <img id="modal-main-img" src="" class="w-full aspect-square object-contain bg-slate-50 rounded-2xl mb-4">
            <div id="modal-thumbnails" class="flex gap-2 overflow-x-auto hide-scrollbar mb-6"></div>
            <h2 id="modal-title" class="text-xl font-bold text-slate-900 mb-1"></h2>
            <p id="modal-price" class="text-2xl font-black text-orange-600 mb-4"></p>
            <div class="bg-slate-50 p-4 rounded-xl mb-6">
                <h3 class="text-sm font-bold text-slate-500 uppercase mb-2">รายละเอียด</h3>
                <p id="modal-desc" class="text-slate-600 text-sm leading-relaxed whitespace-pre-line"></p>
            </div>
            <div id="modal-action-area" class="pb-6"></div>
        </div>
    </div>
</div>

<div id="cart-sidebar" class="fixed inset-0 z-[70] cart-sidebar cart-closed flex flex-col pointer-events-none">
    <div class="mt-auto bg-white rounded-t-[32px] shadow-2xl flex flex-col max-h-[85vh] pointer-events-auto">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-2" onclick="toggleCart()"></div>
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <h2 class="text-lg font-bold">ตะกร้าของคุณ</h2>
            <span id="cart-total" class="text-orange-600 font-black">฿0</span>
        </div>
        <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
        <div class="p-6 bg-white border-t">
            <button onclick="openCheckout()" class="w-full bg-[#002D72] text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-900/20 active:scale-95 transition-transform">
                สั่งซื้อสินค้า
            </button>
        </div>
    </div>
    <div id="cart-overlay" onclick="toggleCart()" class="absolute inset-0 -z-10 bg-black/40 backdrop-blur-sm pointer-events-auto"></div>
</div>

<div id="checkout-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
    <div class="bg-white w-full max-w-md mobile-sheet sm:rounded-3xl p-6">
        <h3 class="text-xl font-bold mb-6 text-center">ข้อมูลจัดส่ง</h3>
        <div class="space-y-4">
<input type="text" id="cust_name" placeholder="ชื่อ-นามสกุล" maxlength="40" class="w-full p-4 bg-slate-100 rounded-xl border-none">
            <input 
  type="tel" 
  id="cust_phone" 
  placeholder="เบอร์โทรศัพท์" 
  maxlength="10" 
  oninput="this.value = this.value.replace(/[^0-9]/g, '');"
  class="w-full p-4 bg-slate-100 rounded-xl border-none"
>
            <textarea id="cust_address" placeholder="ที่อยู่จัดส่ง" rows="3" class="w-full p-4 bg-slate-100 rounded-xl border-none"></textarea>
            <div class="flex gap-3 pt-4">
                <button onclick="closeCheckout()" class="flex-1 py-4 text-slate-400 font-bold">ยกเลิก</button>
                <button onclick="submitOrder()" id="btn-submit" class="flex-[2] bg-orange-600 text-white font-bold py-4 rounded-2xl shadow-lg">ยืนยันสั่งซื้อ</button>
            </div>
        </div>
    </div>
</div>

<div id="login-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6">
    <div class="bg-white w-full max-w-sm rounded-3xl p-8">
        <div class="text-center mb-6">
            <h3 class="text-xl font-bold">แอดมินเข้าสู่ระบบ</h3>
        </div>
        <div class="space-y-4">
            <input type="email" id="login-email" placeholder="อีเมล" class="w-full p-4 bg-slate-100 rounded-xl border-none">
            <input type="password" id="login-password" placeholder="รหัสผ่าน" class="w-full p-4 bg-slate-100 rounded-xl border-none">
            <button onclick="handleLogin()" id="btn-login-submit" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">เข้าสู่ระบบ</button>
            <p id="login-error" class="text-red-500 text-xs text-center hidden"></p>
            <button onclick="closeLoginModal()" class="w-full text-slate-400 text-sm">ปิดหน้าต่าง</button>
        </div>
    </div>
</div>

<script>
    // --- สคริปต์เดิมทั้งหมดจากไฟล์ของคุณ (Supabase logic + Functions) ---
    // [คัดลอกส่วน <script> เดิมของคุณมาวางที่นี่ทั้งหมด]
    // หมายเหตุ: ปรับฟังก์ชัน createProductCardHTML เล็กน้อยตามเลย์เอาต์ใหม่ด้านล่าง:

    const SB_URL = 'https://eodbsetbyryimczkhoaw.supabase.co';
    const SB_KEY = 'sb_publishable_pWCFODdbMNdtx0_tytIXjw_jEry84HD';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let allProducts = [];
    let cart = JSON.parse(localStorage.getItem('my_cart')) || [];
    let currentCategory = 'all';

    function createProductCardHTML(item) {
        const images = parseImages(item);
        return `
            <div class="bg-white rounded-2xl p-3 shadow-sm border border-gray-50 flex flex-col">
                <div class="cursor-pointer overflow-hidden rounded-xl mb-3 bg-slate-50 aspect-square" onclick="openProductModal(${item.id})">
                    <img src="${images[0]}" class="w-full h-full object-contain">
                </div>
                <div class="flex-grow">
                    <h3 onclick="openProductModal(${item.id})" class="text-sm font-medium line-clamp-2 mb-1 leading-tight h-10">${item.name}</h3>
                    <p class="text-lg font-black text-[#002D72]">฿${Number(item.price).toLocaleString()}</p>
                </div>
                <button onclick='addToCartById(${item.id})' class="mt-3 w-full bg-slate-100 text-[#002D72] py-2.5 rounded-xl text-xs font-bold active:bg-[#002D72] active:text-white transition-colors">
                    <i class="fa-solid fa-plus mr-1"></i> เพิ่มลงตะกร้า
                </button>
            </div>
        `;
    }

    function renderCategorizedProducts(products) {
        const container = document.getElementById('sections-container');
        container.innerHTML = '';
        const groups = products.reduce((acc, item) => {
            const cat = item.category || 'อื่นๆ';
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(item);
            return acc;
        }, {});

        Object.keys(groups).sort().forEach(categoryName => {
            const section = document.createElement('section');
            section.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-900">${categoryName}</h2>
                </div>
                <div class="product-grid">
                    ${groups[categoryName].map(item => createProductCardHTML(item)).join('')}
                </div>
            `;
            container.appendChild(section);
        });
    }

    // --- คงฟังก์ชันการทำงานเดิมไว้ทั้งหมด (ยกเว้น UI toggle ที่ใช้ร่วมกับ ID เดิม) ---
    // [คัดลอกฟังก์ชัน getProducts, toggleCart, addToCartById, updateCart ฯลฯ มาวางต่อได้เลย]
    
    // ก๊อปวางฟังก์ชันที่เหลือจากโค้ดเดิมของคุณ:
    async function getProducts() {
        const { data, error } = await _supabase.from('products').select('*');
        if (error) return console.error(error);
        allProducts = data;
        generateCategoryButtons(data);
        filterProducts();
    }

    function generateCategoryButtons(products) {
        const categories = ['all', ...new Set(products.map(p => p.category).filter(Boolean))];
        const container = document.getElementById('category-filters');
        container.innerHTML = '';
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = `whitespace-nowrap px-5 py-2 rounded-xl text-sm font-medium transition-all ${cat === currentCategory ? 'bg-[#002D72] text-white shadow-md' : 'bg-white text-slate-500 border border-gray-100'}`;
            btn.innerText = cat === 'all' ? 'ทั้งหมด' : cat;
            btn.onclick = () => { currentCategory = cat; generateCategoryButtons(allProducts); filterProducts(); };
            container.appendChild(btn);
        });
    }

    function filterProducts() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const filtered = allProducts.filter(item => {
            const matchesSearch = item.name.toLowerCase().includes(searchTerm) || (item.description && item.description.toLowerCase().includes(searchTerm));
            const matchesCategory = currentCategory === 'all' || item.category === currentCategory;
            return matchesSearch && matchesCategory;
        });
        renderCategorizedProducts(filtered);
        document.getElementById('empty-state').classList.toggle('hidden', filtered.length > 0);
    }

    function toggleCart() {
        const sidebar = document.getElementById('cart-sidebar');
        const isOpen = sidebar.classList.contains('cart-open');
        sidebar.classList.toggle('cart-closed', isOpen);
        sidebar.classList.toggle('cart-open', !isOpen);
        document.body.style.overflow = !isOpen ? 'hidden' : 'auto';
    }

    function updateCart() {
        const cartItems = document.getElementById('cart-items');
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');
        localStorage.setItem('my_cart', JSON.stringify(cart));
        cartItems.innerHTML = '';
        let total = 0, count = 0;
        cart.forEach(item => {
            total += Number(item.price) * item.quantity;
            count += item.quantity;
            cartItems.innerHTML += `
                <div class="flex gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-50">
                    <img src="${item.image_url}" class="w-16 h-16 object-contain rounded-lg bg-slate-50 border">
                    <div class="flex-grow">
                        <h4 class="text-xs font-bold line-clamp-1">${item.name}</h4>
                        <p class="text-[#002D72] font-black">฿${Number(item.price).toLocaleString()}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <button onclick="updateQuantity(${item.id}, -1)" class="w-6 h-6 bg-slate-100 rounded-md"><i class="fa-solid fa-minus text-[10px]"></i></button>
                            <span class="text-xs font-bold">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)" class="w-6 h-6 bg-slate-100 rounded-md"><i class="fa-solid fa-plus text-[10px]"></i></button>
                        </div>
                    </div>
                </div>`;
        });
        cartCount.innerText = count;
        cartTotal.innerText = `฿${total.toLocaleString()}`;
        if (cart.length === 0) cartItems.innerHTML = '<p class="text-center py-10 text-slate-400 text-sm">ยังไม่มีสินค้าในตะกร้า</p>';
    }

    function openProductModal(id) {
        const product = allProducts.find(p => p.id === id);
        if(!product) return;
        const mainImg = document.getElementById('modal-main-img');
        const thumbContainer = document.getElementById('modal-thumbnails');
        document.getElementById('modal-title').innerText = product.name;
        document.getElementById('modal-price').innerText = `฿${Number(product.price).toLocaleString()}`;
        document.getElementById('modal-desc').innerText = product.description || 'ไม่มีรายละเอียดสินค้า';
        const imageList = parseImages(product);
        mainImg.src = imageList[0];
        thumbContainer.innerHTML = '';
        imageList.forEach((imgUrl, index) => {
            const thumb = document.createElement('img');
            thumb.src = imgUrl;
            thumb.className = `w-12 h-12 object-cover rounded-lg border-2 ${index === 0 ? 'border-[#002D72]' : 'border-transparent opacity-60'}`;
            thumb.onclick = () => {
                mainImg.src = imgUrl;
                Array.from(thumbContainer.children).forEach(t => t.classList.replace('border-[#002D72]', 'border-transparent'));
                thumb.classList.replace('border-transparent', 'border-[#002D72]');
            };
            thumbContainer.appendChild(thumb);
        });
        document.getElementById('modal-action-area').innerHTML = `<button onclick='addToCartById(${product.id}); closeProductModal();' class="w-full bg-[#002D72] text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-900/10 flex items-center justify-center gap-2"><i class="fa-solid fa-cart-plus"></i> ใส่ตะกร้าเลย</button>`;
        document.getElementById('product-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
    function openLoginModal() { document.getElementById('login-modal').classList.remove('hidden'); }
    function closeLoginModal() { document.getElementById('login-modal').classList.add('hidden'); }
    function openCheckout() { if (cart.length === 0) return; document.getElementById('checkout-modal').classList.remove('hidden'); }
    function closeCheckout() { document.getElementById('checkout-modal').classList.add('hidden'); }
    
    // [คัดลอกส่วนตรรกะอื่นๆ เช่น handleLogin, handleLogout, submitOrder, updateQuantity, parseImages มาไว้ต่อท้าย]
    // สคริปต์ส่วนที่เหลือทำงานร่วมกับ HTML ใหม่นี้ได้ทันที

    function parseImages(item) {
        if (!item.image_url) return ['https://via.placeholder.com/400?text=No+Image'];
        if (Array.isArray(item.image_url)) return item.image_url;
        if (typeof item.image_url === 'string') {
            if (item.image_url.includes(',')) return item.image_url.split(',').map(url => url.trim());
            return [item.image_url];
        }
        return ['https://via.placeholder.com/400?text=Error'];
    }

    function updateQuantity(id, delta) {
        const item = cart.find(item => item.id === id);
        if (item) {
            item.quantity += delta;
            if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
        }
        updateCart();
    }

    function addToCartById(id) {
        const product = allProducts.find(p => p.id === id);
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ id: product.id, name: product.name, price: product.price, image_url: parseImages(product)[0], quantity: 1 });
        }
        updateCart();
        toggleCart();
    }

    async function submitOrder() {
        const name = document.getElementById('cust_name').value.trim();
        const phone = document.getElementById('cust_phone').value.trim();
        const address = document.getElementById('cust_address').value.trim();
        const btn = document.getElementById('btn-submit');
        if (!name || phone.length < 9) return alert("กรุณากรอกข้อมูลให้ครบถ้วน");
        btn.disabled = true;
        btn.innerText = "กำลังสั่งซื้อ...";
        const totalAmount = cart.reduce((sum, item) => sum + (Number(item.price) * item.quantity), 0);
        try {
            const { error } = await _supabase.from('orders').insert([{ customer_name: name, customer_phone: phone, customer_address: address, total_amount: totalAmount, items: cart }]);
            if (error) throw error;
            alert("สั่งซื้อสำเร็จ!");
            cart = []; localStorage.removeItem('my_cart');
            updateCart(); closeCheckout(); toggleCart();
        } catch (err) { alert("ผิดพลาด: " + err.message); } 
        finally { btn.disabled = false; btn.innerText = "ยืนยันสั่งซื้อ"; }
    }

    async function updateAuthUI(session) {
        const adminIcons = document.getElementById('admin-icons');
        const loginBtn = document.getElementById('btn-login-trigger');
        const logoutBtn = document.getElementById('btn-logout-trigger');
        if (session) {
            adminIcons?.classList.remove('hidden');
            loginBtn?.classList.add('hidden');
            logoutBtn?.classList.remove('hidden');
        } else {
            adminIcons?.classList.add('hidden');
            loginBtn?.classList.remove('hidden');
            logoutBtn?.classList.add('hidden');
        }
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorMsg = document.getElementById('login-error');
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) {
            errorMsg.innerText = "ล็อกอินไม่สำเร็จ";
            errorMsg.classList.remove('hidden');
        } else {
            closeLoginModal();
        }
    }

    async function handleLogout() {
        await _supabase.auth.signOut();
        window.location.reload();
    }

    _supabase.auth.onAuthStateChange((event, session) => updateAuthUI(session));
    getProducts();
    updateCart();
</script>
</body>
</html>
