<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองตั๋ว - สงวนชัยอุบล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .brand-gradient { background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); }
        .hidden-section { display: none; }
        .seat { width: 44px; height: 44px; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .seat-available { background-color: #ffffff; border: 2px solid #e2e8f0; color: #64748b; }
        .seat-selected { background-color: #ef4444; border-color: #b91c1c; color: white !important; transform: scale(1.05); }
        .seat-occupied { background-color: #cbd5e1; border: 2px solid #94a3b8; color: #94a3b8; cursor: not-allowed; opacity: 0.6; pointer-events: none; }
        .stepper-active { color: #ef4444; border-bottom: 2px solid #ef4444; font-weight: 600; }
        .ticket-cut { position: relative; }
        .ticket-cut::after { content: ''; position: absolute; bottom: -10px; left: 0; right: 0; height: 20px; background-image: radial-gradient(circle, #f8fafc 10px, transparent 11px); background-size: 30px 40px; background-position: -5px -20px; }
    </style>
</head>
<body class="pb-10">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="showSearchPage()">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold">ส</div>
                <span class="text-xl font-bold text-gray-800">สงวนชัยอุบล</span>
            </div>
            <div id="stepper" class="flex gap-4 text-[10px] md:text-xs font-medium text-gray-400 uppercase tracking-widest">
                <span id="step-1-label" class="stepper-active pb-1">1. เที่ยวรถ</span>
                <span id="step-2-label" class="pb-1">2. ที่นั่ง</span>
                <span id="step-3-label" class="pb-1">3. ชำระเงิน</span>
            </div>
        </div>
    </nav>

    <div id="search-page">
        <div class="brand-gradient h-40 flex items-center justify-center text-white px-4">
            <div class="text-center">
                <h1 class="text-2xl font-bold mb-1">จองตั๋วออนไลน์</h1>
                <p class="text-red-100 text-sm">อุบลราชธานี - กรุงเทพฯ - อำนาจเจริญ</p>
            </div>
        </div>
        <div class="max-w-5xl mx-auto px-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 -translate-y-10">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs text-gray-400">ต้นทาง</label>
                        <select id="origin" class="w-full p-3 border rounded-xl bg-gray-50 outline-none"><option value="กรุงเทพฯ">กรุงเทพฯ</option><option value="อุบลราชธานี">อุบลราชธานี</option></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs text-gray-400">ปลายทาง</label>
                        <select id="destination" class="w-full p-3 border rounded-xl bg-gray-50 outline-none"><option value="อุบลราชธานี">อุบลราชธานี</option><option value="กรุงเทพฯ">กรุงเทพฯ</option></select>
                    </div>
                    <div class="space-y-1"><label class="text-xs text-gray-400">วันที่เดินทาง</label><input type="date" id="travel-date" class="w-full p-3 border rounded-xl bg-gray-50 outline-none"></div>
                    <div class="flex items-end"><button onclick="handleSearch()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 transition-all">ค้นหา</button></div>
                </div>
            </div>
        </div>
        <main class="max-w-5xl mx-auto px-4 -mt-4"><div id="trip-list" class="space-y-3"></div></main>
    </div>

    <div id="seat-page" class="hidden-section container mx-auto px-4 mt-6">
        <div class="max-w-md mx-auto">
            <button onclick="showSearchPage()" class="mb-4 text-gray-500 text-sm flex items-center gap-1">← กลับ</button>
            <div class="bg-white rounded-3xl shadow-lg p-6 border-t-8 border-red-600"><div id="seat-grid" class="space-y-4"></div></div>
        </div>
    </div>

    <div id="payment-page" class="hidden-section max-w-2xl mx-auto px-4 mt-6">
        <button onclick="showSeatPageDirect()" class="mb-4 text-gray-500 text-sm">← แก้ไขที่นั่ง</button>
        <div class="bg-white rounded-2xl shadow-md p-6 mb-6">
            <h2 class="font-bold mb-4 uppercase text-xs tracking-wider text-gray-400">ข้อมูลผู้เดินทาง</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="p-name" placeholder="ชื่อ-นามสกุล" class="w-full p-3 border rounded-xl">
                <input type="tel" id="p-phone" placeholder="เบอร์โทรศัพท์" class="w-full p-3 border rounded-xl">
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-md p-6 border-2 border-red-50 text-center">
            <h2 class="font-bold mb-4">ชำระเงิน (Thai QR)</h2>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SanguanChai" class="mx-auto mb-4 border p-2 rounded-lg">
            <p class="text-2xl font-bold text-red-600 mb-6 font-mono">฿<span id="final-price">0</span></p>
            <input type="file" id="slip-upload" class="mb-6 block w-full text-xs text-gray-400">
            <button onclick="finishBooking()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-700">แจ้งชำระเงิน</button>
        </div>
    </div>

    <div id="success-page" class="hidden-section max-w-md mx-auto px-4 mt-10">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            <div class="brand-gradient p-8 text-center text-white ticket-cut">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold">จองตั๋วสำเร็จ!</h2>
                <p class="text-red-100 text-sm opacity-80">ขอบคุณที่เลือกสงวนชัยอุบล</p>
            </div>
            
            <div class="p-8 pt-10 space-y-6">
                <div class="flex justify-between border-b border-dashed pb-4">
                    <div class="text-xs text-gray-400 uppercase font-bold">ชื่อผู้เดินทาง</div>
                    <div class="font-bold text-gray-800" id="res-name">-</div>
                </div>
                <div class="grid grid-cols-2 gap-4 border-b border-dashed pb-4">
                    <div>
                        <div class="text-xs text-gray-400 uppercase font-bold">เที่ยวรถ</div>
                        <div class="font-bold text-gray-800" id="res-trip">-</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 uppercase font-bold">เวลาเดินทาง</div>
                        <div class="font-bold text-gray-800" id="res-time">-</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 border-b border-dashed pb-4">
                    <div>
                        <div class="text-xs text-gray-400 uppercase font-bold">ที่นั่ง</div>
                        <div class="font-bold text-red-600 text-xl" id="res-seats">-</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 uppercase font-bold">ราคาสุทธิ</div>
                        <div class="font-bold text-gray-800 text-xl">฿<span id="res-total">0</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-xl text-center">
                    <p class="text-[10px] text-gray-400 mb-2 uppercase tracking-widest font-bold">Booking ID</p>
                    <p class="text-lg font-mono font-bold text-gray-600" id="res-id">SCU-XXXX-XXXX</p>
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="window.print()" class="flex-1 border-2 border-gray-200 text-gray-600 font-bold py-3 rounded-xl text-sm">บันทึกรูปภาพ</button>
                    <button onclick="location.reload()" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-xl text-sm shadow-lg shadow-red-200">จองเพิ่มอีก</button>
                </div>
            </div>
        </div>
        <p class="text-center text-gray-400 text-xs mt-6 px-6">กรุณาแสดงหน้าจอนี้ต่อเจ้าหน้าที่ ณ จุดจำหน่ายตั๋วเพื่อรับตั๋วตัวจริงก่อนเวลารถออก 30 นาที</p>
    </div>

    <div id="summary-bar" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 z-40 transform translate-y-full transition-transform">
        <div class="max-w-md mx-auto flex justify-between items-center px-4">
            <div><p class="text-xs text-gray-400 uppercase font-bold">ที่นั่ง <span id="selected-seats-text" class="text-red-600"></span></p><p class="text-2xl font-bold text-gray-800">฿<span id="total-price">0</span></p></div>
            <button onclick="showPaymentPage()" class="bg-red-600 text-white py-3 px-10 rounded-xl font-bold">ถัดไป</button>
        </div>
    </div>

<script>
    // 1. ตั้งค่าเริ่มต้น
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMxDgpsDMzwtHGUsKBF1EdL6F6b1nYUwQPs2ZpdDqw0xwjChcZG2aX2AHe2ovSNnI/exec"; 
    const trips = [
        { id: 101, origin: 'กรุงเทพฯ', destination: 'อุบลราชธานี', time: '20:30', price: 685, type: 'VIP 24' },
        { id: 201, origin: 'อุบลราชธานี', destination: 'กรุงเทพฯ', time: '19:00', price: 685, type: 'VIP 24' }
    ];
    let bookedSeatsStore = []; 
    let selectedSeats = [];
    let currentTrip = null;

    // 2. ฟังก์ชันหลัก
    function showSearchPage() { 
        hideAllPages(); 
        document.getElementById('search-page').classList.remove('hidden-section'); 
        updateStepper(1); 
    }

    async function showSeatPage(tripId) { 
        currentTrip = trips.find(t => t.id === tripId); 
        hideAllPages(); 
        document.getElementById('seat-page').classList.remove('hidden-section'); 
        
        // แก้ไข: เช็คแค่ว่ามี URL หรือไม่ (ลบเงื่อนไขที่เอา URL ไปเทียบกับ String เดิมออก)
        if (SCRIPT_URL && SCRIPT_URL !== "") {
            await loadBookedSeats(); 
        } else {
            renderSeats(); 
        }
        
        updateSummary(); 
        updateStepper(2); 
    }

    function showSeatPageDirect() { 
        hideAllPages(); 
        document.getElementById('seat-page').classList.remove('hidden-section'); 
        renderSeats(); 
        updateSummary(); 
    }

    function showPaymentPage() { 
        if (selectedSeats.length === 0) return alert('เลือกที่นั่งก่อนครับ'); 
        hideAllPages(); 
        document.getElementById('payment-page').classList.remove('hidden-section'); 
        document.getElementById('final-price').innerText = (selectedSeats.length * currentTrip.price).toLocaleString(); 
        updateStepper(3); 
    }

    function hideAllPages() { 
        document.querySelectorAll('[id$="-page"]').forEach(el => el.classList.add('hidden-section')); 
        document.getElementById('summary-bar').classList.add('translate-y-full'); 
    }

    function updateStepper(step) { 
        const stepper = document.getElementById('stepper');
        if (stepper) stepper.style.display = step === 4 ? 'none' : 'flex'; 
        document.querySelectorAll('[id$="-label"]').forEach(el => el.classList.remove('stepper-active')); 
        if(step < 4) {
            const label = document.getElementById(`step-${step}-label`);
            if (label) label.classList.add('stepper-active');
        }
    }

    function handleSearch() { 
        const ori = document.getElementById('origin').value; 
        const dest = document.getElementById('destination').value; 
        const filtered = trips.filter(t => t.origin === ori && t.destination === dest); 
        renderTrips(filtered); 
    }

    function renderTrips(data) { 
        const container = document.getElementById('trip-list'); 
        container.innerHTML = data.length ? '' : '<p class="text-center py-10">ไม่พบเที่ยวรถ</p>'; 
        data.forEach(trip => { 
            container.innerHTML += `
                <div class="bg-white p-5 rounded-xl border flex justify-between items-center shadow-sm">
                    <div>
                        <div class="text-2xl font-bold">${trip.time}</div>
                        <div class="text-xs text-blue-500 font-bold">${trip.type}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-red-600">฿${trip.price}</div>
                        <button onclick="showSeatPage(${trip.id})" class="mt-2 bg-red-600 text-white px-6 py-2 rounded-lg text-sm font-bold">เลือก</button>
                    </div>
                </div>`; 
        }); 
    }

    function renderSeats() { 
        const grid = document.getElementById('seat-grid'); 
        grid.innerHTML = '<div class="flex justify-between mb-4 border-b pb-2 text-[10px] text-gray-300 uppercase tracking-widest font-bold"><span>หน้า</span><span>หลัง</span></div>'; 
        for(let i=1; i<=6; i++) { 
            grid.innerHTML += `<div class="flex justify-between items-center">${createSeatHtml(i+'A')}<div class="w-10"></div><div class="flex gap-3">${createSeatHtml(i+'B')}${createSeatHtml(i+'C')}</div></div>`; 
        } 
    }

    function createSeatHtml(id) { 
        const isOcc = bookedSeatsStore.includes(id); 
        const isSel = selectedSeats.includes(id); 
        return `<div class="seat ${isOcc ? 'seat-occupied' : (isSel ? 'seat-selected' : 'seat-available')}" ${isOcc ? '' : `onclick="toggleSeat(this, '${id}')"`}>${id}</div>`; 
    }

    function toggleSeat(el, id) { 
        if (selectedSeats.includes(id)) { 
            selectedSeats = selectedSeats.filter(s => s !== id); 
            el.classList.replace('seat-selected', 'seat-available'); 
        } else { 
            selectedSeats.push(id); 
            el.classList.replace('seat-available', 'seat-selected'); 
        } 
        updateSummary(); 
    }

    function updateSummary() { 
        const bar = document.getElementById('summary-bar'); 
        const seatPage = document.getElementById('seat-page');
        if (!seatPage || seatPage.classList.contains('hidden-section')) return; 
        document.getElementById('selected-seats-text').innerText = selectedSeats.join(', '); 
        document.getElementById('total-price').innerText = (selectedSeats.length * (currentTrip ? currentTrip.price : 0)).toLocaleString(); 
        selectedSeats.length > 0 ? bar.classList.remove('translate-y-full') : bar.classList.add('translate-y-full'); 
    }

    // 3. เชื่อมต่อ Google Sheets
    async function loadBookedSeats() {
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            bookedSeatsStore = await response.json();
            renderSeats(); 
        } catch (error) { 
            console.error("Error loading seats:", error);
            renderSeats(); 
        }
    }

    async function finishBooking() {
    const nameInput = document.getElementById('p-name');
    const slipInput = document.getElementById('slip-upload');
    if(!nameInput.value || !slipInput.files[0]) return alert('กรุณากรอกชื่อและแนบสลิปครับ');

    const btn = document.querySelector("button[onclick='finishBooking()']");
    btn.innerText = "กำลังบันทึก...";
    btn.disabled = true;

    try {
        if (SCRIPT_URL && SCRIPT_URL !== "") {
            // ใช้เทคนิคการส่งแบบปกติ แต่ตรวจสอบสถานะจาก JSON
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ name: nameInput.value, seats: selectedSeats }),
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // ใช้ text/plain เพื่อเลี่ยง Preflight CORS
                }
            });

            const result = await response.json();
            
            if (result.status === "error") {
                alert("จองไม่สำเร็จ: " + result.message);
                btn.disabled = false;
                btn.innerText = "แจ้งชำระเงิน";
                await loadBookedSeats(); 
                return;
            }
        }

        // --- ส่วนแสดงหน้าสำเร็จ (เหมือนเดิม) ---
        document.getElementById('res-name').innerText = nameInput.value;
        document.getElementById('res-trip').innerText = `${currentTrip.origin} - ${currentTrip.destination}`;
        document.getElementById('res-time').innerText = currentTrip.time + " น.";
        document.getElementById('res-seats').innerText = selectedSeats.join(', ');
        document.getElementById('res-total').innerText = (selectedSeats.length * currentTrip.price).toLocaleString();
        document.getElementById('res-id').innerText = "SCU-" + Math.random().toString(36).substr(2, 9).toUpperCase();

        hideAllPages();
        document.getElementById('success-page').classList.remove('hidden-section');
        updateStepper(4);
        window.scrollTo(0,0);

    } catch (error) {
        // หากเกิด Error จาก CORS แต่ข้อมูลบันทึกสำเร็จ (พบได้บ่อยใน Google Script)
        // ให้ลองดักเช็คว่าจริงๆ บันทึกสำเร็จไหม หรือให้ข้ามไปหน้าสำเร็จเลยถ้าคุณมั่นใจว่า Logic ฝั่ง GS ทำงานแล้ว
        console.error("Fetch error:", error);
        
        // ทางแก้ชั่วคราว: หากยังติด CORS แต่ข้อมูลลง Sheet แล้ว ให้ใช้ Alert แจ้งผู้ใช้
        alert("บันทึกข้อมูลเรียบร้อยแล้ว (หากข้อมูลไม่ขึ้นกรุณาติดต่อเจ้าหน้าที่)");
        location.reload(); 
    }
}

    document.getElementById('travel-date').valueAsDate = new Date();
    handleSearch();
</script>

</body>
</html>
