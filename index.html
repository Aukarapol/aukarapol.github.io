<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khuang Nai Tech Hub - Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .mobile-sheet {
            transition: transform 0.3s ease-out;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
        }
        .cart-sidebar { transition: transform 0.3s ease-in-out; }
        .cart-open { transform: translateY(0); }
        .cart-closed { transform: translateY(100%); }
    </style>
</head>
<body class="bg-[#F8F9FA] text-slate-900 pb-24">

<nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-gray-100 px-4 py-3">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <span class="bg-[#002D72] text-white px-2 py-0.5 rounded font-black italic text-lg">KN</span>
            <span class="font-bold text-lg text-[#002D72]">Tech<span class="text-orange-600">Hub</span></span>
        </div>
        <div id="admin-icons" class="hidden flex gap-4">
            <a href="admin-products.html" class="text-slate-600"><i class="fa-solid fa-boxes-stacked"></i></a>
            <a href="admin-orders.html" class="text-slate-600"><i class="fa-solid fa-clipboard-list"></i></a>
        </div>
		
		<div id="user-profile" class="hidden mt-2 text-right px-4 py-2 bg-slate-50 rounded-2xl border border-slate-100">
        <p class="text-[11px] font-bold text-[#002D72]">ยินดีต้อนรับ: <span id="display-name" class="text-orange-600">-</span></p>
        <p class="text-[10px] text-slate-500"><i class="fa-solid fa-phone scale-75"></i> <span id="display-phone">-</span></p>
        <p class="text-[9px] text-slate-400 mt-1">เข้าระบบล่าสุด: <span id="display-last-login">-</span></p>
        </div>
    </div>

</nav>

<main class="px-4">
    <div class="mt-4 relative">
        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
        <input type="text" id="search-input" oninput="filterProducts()" 
            placeholder="ค้นหาอุปกรณ์ไอที..." 
            class="w-full pl-10 pr-4 py-3 bg-white border-none rounded-2xl shadow-sm focus:ring-2 focus:ring-[#002D72] outline-none text-sm">
    </div>

    <div class="mt-6 rounded-3xl bg-gradient-to-br from-[#002D72] to-[#004dc4] p-6 text-white relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-xl font-bold leading-tight">อัปเกรดชีวิตดิจิทัล<br>ให้โปรกว่าใคร</h2>
            <p class="text-blue-100 text-xs mt-2 opacity-80">รวมสินค้า IT ตัวท็อป ราคาโดนใจ</p>
        </div>
        <i class="fa-solid fa-microchip absolute -right-4 -bottom-4 text-6xl text-white/10 rotate-12"></i>
    </div>

    <div class="mt-8">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold">หมวดหมู่สินค้า</h3>
        </div>
        <div id="category-filters" class="flex gap-2 overflow-x-auto hide-scrollbar"></div>
    </div>

    <div id="sections-container" class="mt-6 space-y-8"></div>

    <div id="empty-state" class="hidden text-center py-12">
        <p class="text-slate-400">ไม่พบสินค้า</p>
    </div>
</main>

<div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center z-50 bottom-nav">
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="flex flex-col items-center gap-1 text-[#002D72]">
        <i class="fa-solid fa-house text-xl"></i>
        <span class="text-[10px] font-medium">หน้าแรก</span>
    </button>
    
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="flex flex-col items-center gap-1 text-[#002D72]">
        <i class="fa-solid fa-table-cells-large text-xl"></i>
        <span class="text-[10px] font-medium">หมวดหมู่</span>
    </button>
    
    <button onclick="toggleCart()" class="relative flex flex-col items-center gap-1 text-[#002D72]">
        <i class="fa-solid fa-bag-shopping text-xl"></i>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-orange-600 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center border-2 border-white">0</span>
        <span class="text-[10px] font-medium">ตะกร้า</span>
    </button>
    
<button onclick="openOrderHistory()" class="flex flex-col items-center gap-1 text-[#002D72]">
    <i class="fa-solid fa-box text-xl"></i>
    <span class="text-[10px] font-medium">คำสั่งซื้อ</span>
</button>

    <div id="auth-section" class="flex flex-col items-center">
        <button id="btn-login-trigger" onclick="openLoginModal()" class="flex flex-col items-center gap-1 text-[#002D72]">
            <i class="fa-regular fa-circle-user text-xl"></i>
            <span class="text-[10px] font-medium">บัญชี</span>
        </button>
        <button id="btn-logout-trigger" onclick="handleLogout()" class="hidden flex flex-col items-center gap-1 text-[#002D72]">
            <i class="fa-solid fa-power-off text-xl"></i>
            <span class="text-[10px] font-medium">ออกจากระบบ</span>
        </button>
    </div>
</div>

<div id="product-modal" class="fixed inset-0 bg-black/60 z-[60] hidden">
    <div class="absolute bottom-0 left-0 right-0 bg-white mobile-sheet max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white px-4 py-3 border-b flex justify-between items-center">
            <span class="font-bold">รายละเอียดสินค้า</span>
            <button onclick="closeProductModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="p-4">
            <img id="modal-main-img" src="" class="w-full aspect-square object-contain bg-slate-50 rounded-2xl mb-4">
            <div id="modal-thumbnails" class="flex gap-2 overflow-x-auto hide-scrollbar mb-6"></div>
            <h2 id="modal-title" class="text-xl font-bold text-slate-900 mb-1"></h2>
            <p id="modal-price" class="text-2xl font-black text-orange-500 mb-4"></p>
            <div class="bg-slate-50 p-4 rounded-xl mb-6">
                <h3 class="text-sm font-bold text-slate-500 uppercase mb-2">รายละเอียด</h3>
                <p id="modal-desc" class="text-slate-600 text-sm leading-relaxed whitespace-pre-line"></p>
            </div>
            <div id="modal-action-area" class="pb-6"></div>
        </div>
    </div>
</div>

<div id="cart-sidebar" class="fixed inset-0 z-[70] cart-sidebar cart-closed flex flex-col pointer-events-none">
    <div class="mt-auto bg-white rounded-t-[32px] shadow-2xl flex flex-col max-h-[85vh] pointer-events-auto">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-2" onclick="toggleCart()"></div>
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <h2 class="text-lg font-bold">ตะกร้าของคุณ</h2>
            <span id="cart-total" class="text-orange-600 font-black">฿0</span>
        </div>
        <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
        <div class="p-6 bg-white border-t">
            <button id="btn-checkout-final" onclick="openCheckout()" class="w-full bg-[#002D72] text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">
                สั่งซื้อสินค้า
            </button>
        </div>
    </div>
    <div id="cart-overlay" onclick="toggleCart()" class="absolute inset-0 -z-10 bg-black/40 backdrop-blur-sm pointer-events-auto"></div>
</div>

<div id="checkout-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
    <div class="bg-white w-full max-w-md mobile-sheet sm:rounded-3xl p-6">
        <h3 class="text-xl font-bold mb-6 text-center">ข้อมูลจัดส่ง</h3>
        <div class="space-y-4">
            <input type="text" id="cust_name" placeholder="ชื่อ-นามสกุล" maxlength="40" class="w-full p-4 bg-slate-100 rounded-xl border-none">
            <input type="tel" id="cust_phone" placeholder="เบอร์โทรศัพท์" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '');" class="w-full p-4 bg-slate-100 rounded-xl border-none">
            <textarea id="cust_address" placeholder="ที่อยู่จัดส่ง" rows="3" class="w-full p-4 bg-slate-100 rounded-xl border-none"></textarea>
            <div class="flex gap-3 pt-4">
                <button onclick="closeCheckout()" class="flex-1 py-4 text-slate-400 font-bold">ยกเลิก</button>
                <button onclick="submitOrder()" id="btn-submit" class="flex-[2] bg-orange-600 text-white font-bold py-4 rounded-2xl shadow-lg">ยืนยันสั่งซื้อ</button>
            </div>
        </div>
    </div>
</div>

<div id="login-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
        <div class="flex justify-around mb-6 border-b border-slate-100 pb-2">
            <button onclick="toggleAuthForm('login')" id="tab-login" class="text-lg font-bold text-[#002D72] border-b-2 border-[#002D72] pb-2 px-4">เข้าสู่ระบบ</button>
            <button onclick="toggleAuthForm('register')" id="tab-register" class="text-lg font-bold text-slate-400 pb-2 px-4">สมัครสมาชิก</button>
        </div>
        <div id="login-error" class="hidden bg-red-100 text-red-600 p-3 rounded-xl text-sm mb-4 text-center"></div>
        <div id="form-login" class="space-y-4">
            <input type="email" id="login-email" placeholder="อีเมล" class="w-full p-3 bg-slate-100 rounded-xl border-none">
            <input type="password" id="login-password" placeholder="รหัสผ่าน" class="w-full p-3 bg-slate-100 rounded-xl border-none">
            <button onclick="handleLogin()" class="w-full bg-[#002D72] text-white py-4 rounded-xl font-bold mt-2">เข้าสู่ระบบ</button>
        </div>
        <div id="form-register" class="space-y-4 hidden">
            <input type="email" id="register-email" placeholder="อีเมล" class="w-full p-3 bg-slate-100 rounded-xl border-none">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="reg-fname" placeholder="ชื่อ" maxlength="20" class="w-full p-3 bg-slate-100 rounded-xl border-none">
                <input type="text" id="reg-lname" placeholder="นามสกุล" maxlength="20" class="w-full p-3 bg-slate-100 rounded-xl border-none">
            </div>
            <input type="tel" id="reg-phone" placeholder="เบอร์โทรศัพท์" maxlength="10" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10)" class="w-full p-3 bg-slate-100 rounded-xl border-none focus:ring-2 focus:ring-[#002D72] outline-none">
            <input type="password" id="reg-password" placeholder="รหัสผ่าน" class="w-full p-3 bg-slate-100 rounded-xl border-none">
            <button onclick="handleRegister()" class="w-full bg-[#002D72] text-white py-4 rounded-xl font-bold mt-2">สมัครสมาชิก</button>
        </div>
        <div class="mt-6 text-center">
            <button onclick="closeLoginModal()" class="text-slate-400 text-sm">ปิดหน้าต่าง</button>
        </div>
    </div>
</div>

<div id="order-history-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h3 class="text-xl font-bold text-[#002D72]"><i class="fa-solid fa-clock-rotate-left mr-2"></i>ประวัติการสั่งซื้อ</h3>
            <button onclick="closeOrderHistory()" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        
        <div id="order-list-container" class="space-y-4">
            <p class="text-center text-slate-400 py-8">กำลังโหลดข้อมูล...</p>
        </div>
    </div>
</div>


<script>
    const SB_URL = 'https://eodbsetbyryimczkhoaw.supabase.co';
    const SB_KEY = 'sb_publishable_pWCFODdbMNdtx0_tytIXjw_jEry84HD';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let allProducts = [];
    let cart = JSON.parse(localStorage.getItem('my_cart')) || [];
    let currentCategory = 'all';

    async function getProducts() {
        const { data, error } = await _supabase.from('products').select('*');
        if (error) return console.error(error);
        allProducts = data;
        generateCategoryButtons(data);
        filterProducts();
    }

function createProductCardHTML(item) {
    const images = parseImages(item);
    return `
        <div class="group bg-white rounded-2xl border border-gray-100 flex flex-col overflow-hidden hover:shadow-xl hover:shadow-gray-200/50 transition-all duration-300 h-full relative">
            
            <div class="relative cursor-pointer overflow-hidden bg-gray-50 aspect-square max-h-[180px] sm:max-h-[200px] md:max-h-[220px]" 
                 onclick="openProductModal(${item.id})">
                <img src="${images[0]}" 
                     class="w-full h-full object-contain p-4 transform transition-transform duration-500 group-hover:scale-110"
                     alt="${item.name}">
                
                <div class="absolute top-2 left-2 bg-white/80 backdrop-blur-sm text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm text-gray-600">
                    Hot
                </div>
            </div>

            <div class="p-3 md:p-4 flex flex-col flex-grow">
                <h3 onclick="openProductModal(${item.id})" 
                    class="text-[13px] md:text-sm font-semibold text-gray-800 line-clamp-2 mb-2 leading-snug cursor-pointer group-hover:text-[#002D72] transition-colors h-9">
                    ${item.name}
                </h3>
                
                <div class="mt-auto flex items-center justify-between">
                    <div>
                        <span class="block text-[10px] uppercase tracking-wider text-gray-400 font-bold">ราคา</span>
                        <p class="text-base md:text-lg font-extrabold text-orange-500">
                            ฿${Number(item.price).toLocaleString()}
                        </p>
                    </div>

                    <button onclick='addToCartById(${item.id})' 
                        class="bg-[#002D72] text-white w-9 h-9 rounded-xl flex items-center justify-center shadow-lg shadow-[#002D72]/20 hover:bg-[#003d96] active:scale-90 transition-all">
                        <i class="fa-solid fa-cart-shopping text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

    function renderCategorizedProducts(products) {
        const container = document.getElementById('sections-container');
        container.innerHTML = '';
        const groups = products.reduce((acc, item) => {
            const cat = item.category || 'อื่นๆ';
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(item);
            return acc;
        }, {});

        Object.keys(groups).sort().forEach(categoryName => {
            const section = document.createElement('section');
            section.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-900">${categoryName}</h2>
                </div>
                <div class="product-grid">
                    ${groups[categoryName].map(item => createProductCardHTML(item)).join('')}
                </div>
            `;
            container.appendChild(section);
        });
    }

    function generateCategoryButtons(products) {
        const categories = ['all', ...new Set(products.map(p => p.category).filter(Boolean))];
        const container = document.getElementById('category-filters');
        container.innerHTML = '';
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = `whitespace-nowrap px-5 py-2 rounded-xl text-sm font-medium transition-all ${cat === currentCategory ? 'bg-[#002D72] text-white shadow-md' : 'bg-white text-slate-500 border border-gray-100'}`;
            btn.innerText = cat === 'all' ? 'ทั้งหมด' : cat;
            btn.onclick = () => { currentCategory = cat; generateCategoryButtons(allProducts); filterProducts(); };
            container.appendChild(btn);
        });
    }

    function filterProducts() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const filtered = allProducts.filter(item => {
            const matchesSearch = item.name.toLowerCase().includes(searchTerm) || (item.description && item.description.toLowerCase().includes(searchTerm));
            const matchesCategory = currentCategory === 'all' || item.category === currentCategory;
            return matchesSearch && matchesCategory;
        });
        renderCategorizedProducts(filtered);
        document.getElementById('empty-state').classList.toggle('hidden', filtered.length > 0);
    }

    function toggleCart() {
        const sidebar = document.getElementById('cart-sidebar');
        const isOpen = sidebar.classList.contains('cart-open');
        sidebar.classList.toggle('cart-closed', isOpen);
        sidebar.classList.toggle('cart-open', !isOpen);
        document.body.style.overflow = !isOpen ? 'hidden' : 'auto';
    }

    function updateCart() {
        const cartItems = document.getElementById('cart-items');
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');
        localStorage.setItem('my_cart', JSON.stringify(cart));
        cartItems.innerHTML = '';
        let total = 0, count = 0;
        cart.forEach(item => {
            total += Number(item.price) * item.quantity;
            count += item.quantity;
            cartItems.innerHTML += `
                <div class="flex gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-50">
                    <img src="${item.image_url}" class="w-16 h-16 object-contain rounded-lg bg-slate-50 border">
                    <div class="flex-grow">
                        <h4 class="text-xs font-bold line-clamp-1">${item.name}</h4>
                        <p class="text-[#002D72] font-black">฿${Number(item.price).toLocaleString()}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <button onclick="updateQuantity(${item.id}, -1)" class="w-6 h-6 bg-slate-100 rounded-md"><i class="fa-solid fa-minus text-[10px]"></i></button>
                            <span class="text-xs font-bold">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)" class="w-6 h-6 bg-slate-100 rounded-md"><i class="fa-solid fa-plus text-[10px]"></i></button>
                        </div>
                    </div>
                </div>`;
        });
        cartCount.innerText = count;
        cartTotal.innerText = `฿${total.toLocaleString()}`;
        if (cart.length === 0) cartItems.innerHTML = '<p class="text-center py-10 text-slate-400 text-sm">ยังไม่มีสินค้าในตะกร้า</p>';
    }

    function openProductModal(id) {
        const product = allProducts.find(p => p.id === id);
        if(!product) return;
        const mainImg = document.getElementById('modal-main-img');
        const thumbContainer = document.getElementById('modal-thumbnails');
        document.getElementById('modal-title').innerText = product.name;
        document.getElementById('modal-price').innerText = `฿${Number(product.price).toLocaleString()}`;
        document.getElementById('modal-desc').innerText = product.description || 'ไม่มีรายละเอียดสินค้า';
        const imageList = parseImages(product);
        mainImg.src = imageList[0];
        thumbContainer.innerHTML = '';
        imageList.forEach((imgUrl, index) => {
            const thumb = document.createElement('img');
            thumb.src = imgUrl;
            thumb.className = `w-12 h-12 object-cover rounded-lg border-2 ${index === 0 ? 'border-[#002D72]' : 'border-transparent opacity-60'}`;
            thumb.onclick = () => {
                mainImg.src = imgUrl;
                Array.from(thumbContainer.children).forEach(t => t.classList.replace('border-[#002D72]', 'border-transparent'));
                thumb.classList.replace('border-transparent', 'border-[#002D72]');
            };
            thumbContainer.appendChild(thumb);
        });
        document.getElementById('modal-action-area').innerHTML = `<button onclick='addToCartById(${product.id}); closeProductModal();' class="w-full bg-[#002D72] text-white py-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-cart-plus"></i> ใส่ตะกร้าเลย</button>`;
        document.getElementById('product-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
    function openLoginModal() { document.getElementById('login-modal').classList.remove('hidden'); }
    function closeLoginModal() { document.getElementById('login-modal').classList.add('hidden'); }
    
    async function openCheckout() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) {
            alert("กรุณาเข้าสู่ระบบก่อนดำเนินการสั่งซื้อครับ");
            openLoginModal();
            return;
        }
        document.getElementById('checkout-modal').classList.remove('hidden');
    }

    function closeCheckout() { document.getElementById('checkout-modal').classList.add('hidden'); }

    function parseImages(item) {
        if (!item.image_url) return ['https://via.placeholder.com/400?text=No+Image'];
        if (Array.isArray(item.image_url)) return item.image_url;
        if (typeof item.image_url === 'string') {
            if (item.image_url.includes(',')) return item.image_url.split(',').map(url => url.trim());
            return [item.image_url];
        }
        return ['https://via.placeholder.com/400?text=Error'];
    }

    function updateQuantity(id, delta) {
        const item = cart.find(item => item.id === id);
        if (item) {
            item.quantity += delta;
            if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
        }
        updateCart();
    }

    function addToCartById(id) {
        const product = allProducts.find(p => p.id === id);
        if (!product) return;
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ id: product.id, name: product.name, price: product.price, image_url: parseImages(product)[0], quantity: 1 });
        }
        updateCart();
        toggleCart();
    }

    async function submitOrder() {
        const name = document.getElementById('cust_name').value.trim();
        const phone = document.getElementById('cust_phone').value.trim();
        const address = document.getElementById('cust_address').value.trim();
        const btn = document.getElementById('btn-submit');
        if (!name || phone.length < 9) return alert("กรุณากรอกข้อมูลให้ครบถ้วน");
        btn.disabled = true;
        btn.innerText = "กำลังสั่งซื้อ...";
        const totalAmount = cart.reduce((sum, item) => sum + (Number(item.price) * item.quantity), 0);
        try {
            const { error } = await _supabase.from('orders').insert([{ customer_name: name, customer_phone: phone, customer_address: address, total_amount: totalAmount, items: cart }]);
            if (error) throw error;
            alert("สั่งซื้อสำเร็จ!");
            cart = []; localStorage.removeItem('my_cart');
            updateCart(); closeCheckout(); toggleCart();
        } catch (err) { alert("ผิดพลาด: " + err.message); } 
        finally { btn.disabled = false; btn.innerText = "ยืนยันสั่งซื้อ"; }
    }
	
// ฟังก์ชันเปิด Modal และดึงข้อมูล
// ฟังก์ชันช่วยเลือกสีและข้อความตามสถานะ
function getStatusBadge(status) {
    // ถ้าไม่มีข้อมูล ให้เป็น 'รอดำเนินการ' ไว้ก่อน
    const currentStatus = status || 'รอดำเนินการ';

    // เช็คข้อความภาษาไทยจาก Database
    switch (currentStatus) {
        case 'ส่งแล้ว':
        case 'สำเร็จ':
            // สีเขียว
            return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200">
                        <i class="fa-solid fa-check-circle mr-1"></i>${currentStatus}
                    </span>`;
        
        case 'กำลังจัดส่ง':
            // สีฟ้า/น้ำเงิน
            return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-700 border border-blue-200">
                        <i class="fa-solid fa-truck-fast mr-1"></i>${currentStatus}
                    </span>`;
            
        case 'ยกเลิก':
            // สีแดง
            return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 border border-red-200">
                        <i class="fa-solid fa-circle-xmark mr-1"></i>${currentStatus}
                    </span>`;

        case 'รอดำเนินการ':
        default:
            // สีเหลือง/ส้ม (สำหรับสถานะอื่นๆ หรือ รอตรวจสอบ)
            return `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800 border border-yellow-200">
                        <i class="fa-regular fa-clock mr-1"></i>${currentStatus}
                    </span>`;
    }
}

async function openOrderHistory() {
    const { data: { session } } = await _supabase.auth.getSession();
    
    // 1. เช็ค Login
    if (!session) {
        alert("กรุณาเข้าสู่ระบบเพื่อดูประวัติการสั่งซื้อ");
        openLoginModal();
        return;
    }

    document.getElementById('order-history-modal').classList.remove('hidden');
    const container = document.getElementById('order-list-container');
    container.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-spinner fa-spin text-[#002D72] text-2xl"></i><p class="text-slate-400 mt-2">กำลังดึงข้อมูล...</p></div>';

    try {
        const userPhone = session.user.user_metadata.phone_number;
        
        if (!userPhone) {
            container.innerHTML = '<p class="text-center text-red-500 py-8">ไม่พบข้อมูลเบอร์โทรศัพท์ในบัญชีของคุณ</p>';
            return;
        }

        // 2. Query ข้อมูล (ดึง status มาด้วย ซึ่ง select * ดึงมาให้อยู่แล้ว)
        const { data, error } = await _supabase
            .from('orders')
            .select('*')
            .eq('customer_phone', userPhone)
            .order('created_at', { ascending: false });

        if (error) throw error;

        // 3. กรณีไม่มีข้อมูล
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 flex flex-col items-center">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fa-solid fa-basket-shopping text-2xl text-slate-400"></i>
                    </div>
                    <p class="text-slate-500 font-medium">ไม่มีประวัติการสั่งซื้อ</p>
                    <p class="text-slate-400 text-xs mt-1">รายการสั่งซื้อของคุณจะปรากฏที่นี่</p>
                </div>`;
            return;
        }

        // 4. แสดงผลรายการ (Loop)
        container.innerHTML = data.map(order => {
            const date = new Date(order.created_at).toLocaleDateString('th-TH', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            // สร้างป้ายสถานะจากข้อมูลใน DB (ส่ง order.status ไป)
            const statusBadge = getStatusBadge(order.status);

            // แปลงรายการสินค้า (JSON) เป็น HTML
            const itemsHtml = Array.isArray(order.items) ? order.items.map(item => `
                <div class="flex justify-between items-center text-xs py-1 border-b border-dashed border-slate-100 last:border-0">
                    <div class="flex items-center gap-2">
                        <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                        <span class="text-slate-600 line-clamp-1 max-w-[150px]">${item.name}</span>
                        <span class="text-slate-400 text-[10px]">x${item.quantity}</span>
                    </div>
                    <span class="font-medium text-slate-700">฿${(Number(item.price) * item.quantity).toLocaleString()}</span>
                </div>
            `).join('') : '<span class="text-xs text-slate-400">ไม่พบรายการสินค้า</span>';

            return `
                <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm mb-3 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-3 pb-3 border-b border-slate-100">
                        <div>
                            <div class="flex items-center gap-2 mb-1.5">
                                ${statusBadge}
                            </div>
                            <p class="text-[10px] text-slate-400 flex items-center gap-1">
                                <i class="fa-regular fa-calendar"></i> ${date}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-[#002D72] font-black text-lg">฿${Number(order.total_amount).toLocaleString()}</p>
                            <p class="text-[9px] text-slate-400">#${order.id.toString().slice(0, 8)}</p>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50/50 rounded-xl p-2.5">
                        ${itemsHtml}
                    </div>
                </div>
            `;
        }).join('');

    } catch (err) {
        console.error(err);
        container.innerHTML = `<div class="p-4 text-center"><p class="text-red-500 text-sm">เกิดข้อผิดพลาด: ${err.message}</p></div>`;
    }
}

function closeOrderHistory() {

    document.getElementById('order-history-modal').classList.add('hidden');

}
	
	
	
	

    async function updateAuthUI(session) {
        const adminIcons = document.getElementById('admin-icons');
        const loginBtn = document.getElementById('btn-login-trigger');
        const logoutBtn = document.getElementById('btn-logout-trigger');
        const userProfile = document.getElementById('user-profile');
        const checkoutBtn = document.getElementById('btn-checkout-final');

        if (session) {
            checkoutBtn.disabled = false;
            checkoutBtn.innerText = "สั่งซื้อสินค้า";
            checkoutBtn.classList.remove('bg-slate-400');
            checkoutBtn.classList.add('bg-[#002D72]');

            const adminEmail = "akrapol2017@hotmail.com"; 
            if (session.user.email === adminEmail) {
                adminIcons?.classList.remove('hidden');
            }

            const meta = session.user.user_metadata;
            const lastLogin = new Date(session.user.last_sign_in_at).toLocaleString('th-TH');

            document.getElementById('display-name').innerText = `${meta.first_name || ''} ${meta.last_name || ''}`;
            document.getElementById('display-phone').innerText = meta.phone_number || 'ไม่ได้ระบุ';
            document.getElementById('display-last-login').innerText = lastLogin;

            userProfile?.classList.remove('hidden');
            loginBtn?.classList.add('hidden');
            logoutBtn?.classList.remove('hidden');
        } else {
            checkoutBtn.innerText = "กรุณาเข้าสู่ระบบเพื่อสั่งซื้อ";
            checkoutBtn.classList.add('bg-slate-400');
            checkoutBtn.classList.remove('bg-[#002D72]');
            
            userProfile?.classList.add('hidden');
            adminIcons?.classList.add('hidden');
            loginBtn?.classList.remove('hidden');
            logoutBtn?.classList.add('hidden');
        }
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorMsg = document.getElementById('login-error');
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) {
            errorMsg.innerText = "ล็อกอินไม่สำเร็จ: " + error.message;
            errorMsg.classList.remove('hidden');
        } else {
            closeLoginModal();
        }
    }

    async function handleLogout() {
        await _supabase.auth.signOut();
        window.location.reload();
    }

    function toggleAuthForm(type) {
        const loginForm = document.getElementById('form-login');
        const registerForm = document.getElementById('form-register');
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');

        if (type === 'register') {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            tabRegister.classList.add('text-[#002D72]', 'border-b-2', 'border-[#002D72]');
            tabRegister.classList.remove('text-slate-400');
            tabLogin.classList.remove('text-[#002D72]', 'border-b-2', 'border-[#002D72]');
            tabLogin.classList.add('text-slate-400');
        } else {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            tabLogin.classList.add('text-[#002D72]', 'border-b-2', 'border-[#002D72]');
            tabLogin.classList.remove('text-slate-400');
            tabRegister.classList.remove('text-[#002D72]', 'border-b-2', 'border-[#002D72]');
            tabRegister.classList.add('text-slate-400');
        }
    }
	

	

    async function handleRegister() {
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('reg-password').value;
        const firstName = document.getElementById('reg-fname').value.trim();
        const lastName = document.getElementById('reg-lname').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();

        if (!email || password.length < 6) {
            alert("กรุณากรอกข้อมูลให้ครบถ้วน (รหัสผ่านต้อง 6 ตัวขึ้นไป)");
            return;
        }

        try {
            const { error } = await _supabase.auth.signUp({
                email: email,
                password: password,
                options: { data: { first_name: firstName, last_name: lastName, phone_number: phone } }
            });
            if (error) throw error;
            alert("สมัครสมาชิกเรียบร้อย!");
            window.location.reload();
        } catch (err) {
            alert("เกิดข้อผิดพลาด: " + err.message);
        }
    }

    _supabase.auth.onAuthStateChange((event, session) => updateAuthUI(session));
    getProducts();
    updateCart();

	
</script>



</body>
</html>
